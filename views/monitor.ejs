<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Health Tracker - Monitor</title>
    <link rel="stylesheet" href="/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // WebSocket for real-time updates
        const ws = new WebSocket('ws://localhost:8080');

        ws.onopen = () => {
            console.log('Connected to WebSocket');
        };

        ws.onmessage = (event) => {
            const message = JSON.parse(event.data);
            if (message.type === 'dataUpdate') {
                console.log('Data updated, refreshing charts...');
                location.reload(); // Simple refresh for now
            }
        };

        ws.onclose = () => {
            console.log('WebSocket connection closed');
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <h1>Health Monitor</h1>
            <p>Real-time dashboard with charts and trends.</p>
        </div>

        <% if (healthData.length > 0) { %>
            <div class="charts-container">
                <div class="chart-wrapper">
                    <h3>Heart Rate Over Time</h3>
                    <canvas id="heartRateChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>SpO2 Over Time</h3>
                    <canvas id="spO2Chart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>Blood Pressure Over Time</h3>
                    <canvas id="bpChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>Temperature Over Time</h3>
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
        <% } else { %>
            <div class="placeholder">
                <h2>No Data Yet</h2>
                <p>Add some health entries to see your charts!</p>
                <a href="/add" class="btn primary">Add Entry</a>
            </div>
        <% } %>
    </div>

    <!-- Bottom Navigation -->
    <nav class="navbar">
        <a href="/" class="nav-item">
            <i class="fas fa-home nav-icon"></i>
            Home
        </a>
        <a href="/monitor" class="nav-item active">
            <i class="fas fa-chart-line nav-icon"></i>
            Monitor
        </a>
        <a href="/appointments" class="nav-item">
            <i class="fas fa-calendar-alt nav-icon"></i>
            Appointments
        </a>
        <a href="/profile" class="nav-item">
            <i class="fas fa-user nav-icon"></i>
            Profile
        </a>
    </nav>

    <script>
        <% if (healthData.length > 0) { %>
            const healthData = <%- JSON.stringify(healthData) %>;

            // Prepare data for charts
            const labels = healthData.map(function(entry) { return entry.date; });
            const heartRates = healthData.map(function(entry) { return entry.heartRate; });
            const spO2s = healthData.map(function(entry) { return entry.spO2; });
            const temperatures = healthData.map(function(entry) { return entry.temperature; });
            const bpSystolic = healthData.map(function(entry) { return parseInt(entry.bloodPressure.split('/')[0]); });
            const bpDiastolic = healthData.map(function(entry) { return parseInt(entry.bloodPressure.split('/')[1]); });

            // Heart Rate Chart
            new Chart(document.getElementById('heartRateChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Heart Rate (bpm)',
                        data: heartRates,
                        borderColor: '#25d366',
                        backgroundColor: 'rgba(37, 211, 102, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // SpO2 Chart
            new Chart(document.getElementById('spO2Chart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'SpO2 (%)',
                        data: spO2s,
                        borderColor: '#25d366',
                        backgroundColor: 'rgba(37, 211, 102, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Blood Pressure Chart
            new Chart(document.getElementById('bpChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Systolic BP',
                        data: bpSystolic,
                        borderColor: '#25d366',
                        backgroundColor: 'rgba(37, 211, 102, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Diastolic BP',
                        data: bpDiastolic,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });

            // Temperature Chart
            new Chart(document.getElementById('temperatureChart'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (Â°C)',
                        data: temperatures,
                        borderColor: '#25d366',
                        backgroundColor: 'rgba(37, 211, 102, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: false }
                    }
                }
            });
        <% } %>
    </script>
</body>
</html>
